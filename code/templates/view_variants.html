{% import 'macros.html' as macros %}
{% extends "layout.html" %}

{% set active_page = "view_variants" %}
{% block title %}
	{{ title }}
{% endblock %}

{% block header %}
	<link href="/static/datatables/datatables.view_variants_specific.css" rel="stylesheet" media="screen">
	<script src="/static/datatables/media/js/jquery.dataTables.min.js"></script>
	<script src="/static/datatables/media/js/ColVis.min.js"></script>
	<script src="/static/datatables/datatables.view_variants_specific.js"></script>	

	<script>


	/* Table initialisation */
	var dtable;
	$(document).ready(function() {
		dtable = $('#example').dataTable( {
			"sDom": "<'row-fluid'<'span6'><'span3'><'span3'f>r>t<'row-fluid'<'span4'i><'span4'l><'span4'p>>",
			"sPaginationType": "bootstrap",
			"oLanguage": {
				"sLengthMenu": "_MENU_ variants per page"
			},
			"bDeferRender": true,
			"aaSorting": [ [0,'asc'], [1,'asc'] ],
			"aoColumns": [ 
				{"sTitle":"Chromosome"},
				{"sTitle":"Start"},
				{"sTitle":"Stop"},
				{"sTitle":"dbSNP","bSearchable": true},
				{"sTitle":"Ref","bSearchable": false},
				{"sTitle":"Alt","bSearchable": false},
				{"sTitle":"Filters/Sets","bSearchable": true},
				{"sTitle":"MQ","bSearchable": false},
				{"sTitle":"id","bSearchable": false},
			],
			"bProcessing": true,
        	"bServerSide": false,
        	"sAjaxSource": "/_variants.json?" + query_string
		} );
		console.log("/_variants.json?" + query_string)	
	} );
</script>

<style>
.filter-tag {display: inline-block; 
			 width: 10px;
			 height: 10px;
			 background-color: gray;
			 margin: 1px;}
.GATK_import {background-color: red;}
.Rare_variants {background-color: blue;}
.Oroak_2012_exome {background-color: orange;}
</style>

<script>

var sets = {}
var query_string = "{{ query_string }}"

function create_set_label(set_item){
	id = set_item.filter_name
	if (set_item["filter_title"] != undefined){
		title = set_item.filter_title
	} else {title = set_item.filter_name}
	color = set_item.color
	return '<div class="btn-group" id='+id+'>' + 
		   '<button class="btn btn '+color+' no-hover">'+title+'</button>' + 
		   '<button class="btn btn '+color+'" onClick=\'remove_filter("'+id+'")\'>x</button></div>'
};

function build_filter_string(sets){
	var filter_string = "include_filters="
		for (var set in sets){
			if (sets[set].applied){
				filter_string += sets[set].filter_name
				filter_string += ";"
			}
		}
	return filter_string
}

function remove_filter(item){
	$("#"+item).remove();
	sets[item].applied = false
	filter_string = build_filter_string(sets)
	console.log('/_variants.json?' + query_string + "&" + filter_string)
	dtable.fnReloadAjax( '/_variants.json?' + query_string + "&" + filter_string);
}

function add_filter(item){
	$('#set_labels').append(create_set_label(sets[item]));
	sets[item].applied = true
	filter_string = build_filter_string(sets)
	console.log('/_variants.json?' + query_string + "&" + filter_string)
	dtable.fnReloadAjax( '/_variants.json?' + query_string + "&" + filter_string);
}

/* download the filters from server, populate the sets[] array and set up the typeahead*/
$(document).ready(function() {
	$.getJSON('/filters.json', function(data){
									data = data["result"]
									for (var i = 0; i < data.length; i++) {
										sets[data[i].filter_name] = data[i]
									}
									$('#set_search').typeahead({'source': Object.keys(sets), 
																'updater': add_filter
															   }
							);
	});
});
</script>  
{% endblock %}

{% block content %}
	<div class="row-fluid">
	<div class="span2">
		<form class="form-inline" action="#">
	  	<input id="set_search" class="span12" type="text" placeholder="Type to find sets..." data-provide="typeahead" autocomplete="off" />
	  	</form>
	</div>
	<div id="set_labels" class="span10">
	</div>
	</div>

	<table class="table table-hover table-condensed" id="example">
	</table>
{% endblock %}
