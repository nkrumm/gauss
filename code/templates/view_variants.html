{% import 'macros.html' as macros %}
{% extends "layout.html" %}

{% set active_page = "view_variants" %}
{% block title %}
	{{ title }}
{% endblock %}

{% block header %}
	<link href="/static/custom.css" rel="stylesheet" media="screen">
	<link href="/static/datatables/datatables.view_variants_specific.css" rel="stylesheet" media="screen">
	<script src="/static/datatables/media/js/jquery.dataTables.min.js"></script>
	<script src="/static/datatables/media/js/ColVis.min.js"></script>
	<script src="/static/datatables/datatables.view_variants_specific.js"></script>	
	<style>
	.toolbar-pills .active a,
	.toolbar-pills .active a:hover {
    	background-color: #888888;
	}
	</style>
	<script>
	var grouping_state = "genotype"

	function toggle_grouping(grouping){
		if (grouping == "variant"){
			dtable.fnReloadAjax('/_variants.json?' + query_string  + filter_string + '&group=variant');
			console.log('/_variants.json?' + query_string + filter_string +  '&group=variant')
			grouping_state = "variant"
			$("#genotype_pill").removeClass("active")
			$("#variant_pill").addClass("active")
		}
		else{
			dtable.fnReloadAjax('/_variants.json?' + query_string + filter_string);
			console.log('/_variants.json?' + query_string + filter_string)
			grouping_state = "genotype"
			$("#genotype_pill").addClass("active")
			$("#variant_pill").removeClass("active")			
		}
	}

	function build_toolbar(){
		html_str = '<ul class="nav nav-pills toolbar-pills">';
		html_str += '<li id="genotype_pill" class="active"><a href="#" onClick="toggle_grouping(\'genotype\')">By genotype</a></li>';
		html_str += '<li id="variant_pill"><a href="#" onClick="toggle_grouping(\'variant\')">By variant</a></li></ul>';
		return html_str
	}
	/* Table initialisation */
	var dtable;
	$(document).ready(function() {
		dtable = $('#example').dataTable( {
			"sDom": "<'row-fluid'<'toolbar span6'><'span3'><'span3'f>r>t<'row-fluid'<'span4'i><'span4'l><'span4'p>>",
			"sPaginationType": "bootstrap",
			"oLanguage": {
				"sLengthMenu": "_MENU_ variants per page"
			},
			"bDeferRender": true,
			"aaSorting": [ [0,'asc'], [1,'asc'] ],
			"bStateSave": true,
			"aoColumns": [ 
				{"sTitle":"Chrom", "sWidth":"5%"},
				{"sTitle":"Start", "sWidth":"7.5%"},
				{"sTitle":"Stop", "sWidth":"7.5%"},
				{"sTitle":"Sample","bSearchable": true, "sWidth":"10%","sType": "numeric"},
				{"sTitle":"dbSNP","bSearchable": true, "sWidth":"10%"},
				{"sTitle":"Ref","bSearchable": false, "sWidth":"3%", "bSortable": false},
				{"sTitle":"Alt","bSearchable": false, "sWidth":"3%", "bSortable": false},
				{"sTitle":"Filters/Sets","bSearchable": true, "sWidth":"10%"},
				{"sTitle":"Gene","bSearchable": true, "sWidth":"10%"},
				{"sTitle":"Effect <a href='#'>highest</a> | <a href='#'>all</a>","bSearchable": true, "sWidth":"15%"},
				{"sTitle":"id","bSearchable": false},
			],
			"bProcessing": true,
        	"bServerSide": false,
        	"sAjaxSource": "/_variants.json?" + query_string
		} );
		console.log("/_variants.json?" + query_string)	
		$("div.toolbar").html(build_toolbar());
	} );
</script>

<style>
.filter-tag {display: inline-block; 
			 width: 10px;
			 height: 10px;
			 background-color: gray;
			 margin: 1px;}
.GATK_filter {background-color: red;}
.Rare_variants {background-color: blue;}
.ORoak_denovo_2012 {background-color: orange;}

</style>

<script>

var sets = {}
var query_string = "{{ query_string }}"
var filter_string = ""

function create_set_label(set_item){
	id = set_item.filter_name
	if (set_item["filter_title"] != undefined){
		title = set_item.filter_title
	} else {title = set_item.filter_name}
	color = set_item.color
	return '<div class="btn-group" id='+id+'>' + 
		   '<button class="btn btn '+color+' no-hover">'+title+'</button>' + 
		   '<button class="btn btn '+color+'" onClick=\'remove_filter("'+id+'")\'>x</button></div>'
};

function build_filter_string(sets){
	var filter_string = "include_filters="
		for (var set in sets){
			if (sets[set].applied){
				filter_string += sets[set].filter_name
				filter_string += ";"
			}
		}
	return filter_string
}

function remove_filter(item){
	$("#"+item).remove();
	sets[item].applied = false
	filter_string = build_filter_string(sets)
	console.log('/_variants.json?' + query_string + "&" + filter_string)
	dtable.fnReloadAjax( '/_variants.json?' + query_string + "&" + filter_string);
}

function add_filter(item){
	$('#set_labels').append(create_set_label(sets[item]));
	sets[item].applied = true
	filter_string = build_filter_string(sets)
	console.log('/_variants.json?' + query_string + "&" + filter_string)
	dtable.fnReloadAjax( '/_variants.json?' + query_string + "&" + filter_string);
}

/* download the filters from server, populate the sets[] array and set up the typeahead*/
$(document).ready(function() {
	$.getJSON('/filters.json', function(data){
									data = data["result"]
									for (var i = 0; i < data.length; i++) {
										sets[data[i].filter_name] = data[i]
									}
									$('#set_search').typeahead({'source': Object.keys(sets), 
																'updater': add_filter
															   }
							);
	});
});
</script>  
{% endblock %}

{% block content %}
	<div class="row-fluid">
	<div class="span2">
		<form class="form-inline" action="#">
	  	<input id="set_search" class="span12" accesskey='s' type="text" placeholder="Type to find sets..." data-provide="typeahead" autocomplete="off" />
	  	</form>
	</div>
	<div id="set_labels" class="span10">
	</div>
	</div>

	<table class="table table-hover table-condensed" id="example">
	</table>
{% endblock %}
